version: 0.1
component: build
timeoutInSeconds: 1200
shell: bash

steps:
  - name: "Configure kubeconfig for OKE"
    command: |
      echo "‚úÖ Configurando acceso al cl√∫ster Kubernetes..."
      oci ce cluster create-kubeconfig \
        --cluster-id ocid1.cluster.oc1.mx-queretaro-1.aaaaaaaa6adn4bnnebm2cmeyf522k5tig6qwnvhp2bjelbxfvca2uanotz2a \
        --file $HOME/.kube/config \
        --region mx-queretaro-1 \
        --token-version 2.0.0 \
        --kube-endpoint PUBLIC_ENDPOINT

  - name: "Verificar conectividad con kubectl"
    command: |
      echo "üîç Verificando conectividad con el cl√∫ster..."
      kubectl get nodes

  - name: "Desplegar aplicaci√≥n"
    command: |
      echo "üöÄ Aplicando deployment.yaml..."
      kubectl apply -f deployment.yaml

  - name: "Esperar a que el servicio est√© disponible"
    command: |
      echo "‚è≥ Esperando IP externa del LoadBalancer..."
      for i in {1..10}; do
        IP=$(kubectl get svc todolistapp-springboot-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        if [[ -n "$IP" ]]; then
          echo "‚úÖ Servicio disponible en: http://$IP"
          break
        else
          echo "‚è≥ A√∫n sin IP, reintentando en 10s..."
          sleep 10
        fi
      done
